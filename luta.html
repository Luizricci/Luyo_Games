<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo Mortal Kombat</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tone@14.7.58/build/Tone.js"></script>
    <style>
        :root {
            --player1-color: #ff3300;
            --player2-color: #00aaff;
            --body-color: #f1c27d;
            --punch-color: #ffff00;
            --kick-color: #ff9900;
            --fireball-color: #ff0000;
            --stamina-color: #33ff33;
            --bg-color: #1a1a1a;
            --ui-color: #e5e7eb;
            --button-start-color: #ffcc00;
            --button-end-color: #ffaa00;
            --button-text-color: #000;
        }

        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #252525;
            color: var(--ui-color);
            font-family: 'Press Start 2P', cursive;
            padding: 10px;
            overflow: hidden;
            text-align: center;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            background: var(--bg-color);
            border: 5px solid #000;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.7);
            max-width: 90%;
            width: 800px;
            box-sizing: content-box;
        }

        @media (max-width: 850px) {
            .game-container {
                width: 95%;
            }
        }

        .ui-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            height: 40px;
            margin-bottom: 5px;
        }

        .health-bar-container,
        .stamina-bar-container {
            width: 45%;
            height: 25px;
            background-color: #4b5563;
            border: 2px solid #9ca3af;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }

        .stamina-bar-container {
            height: 12px;
            border-color: var(--stamina-color);
            margin-top: 5px;
        }

        #player1HealthBar,
        #player2HealthBar,
        #player1StaminaBar,
        #player2StaminaBar {
            height: 100%;
            width: 100%;
            transition: width 0.3s ease-in-out, background-color 0.3s ease-in-out;
            position: absolute;
            top: 0;
            left: 0;
        }

        #player1HealthBar {
            background-color: var(--player1-color);
        }

        #player2HealthBar {
            background-color: var(--player2-color);
            left: auto;
            right: 0;
        }

        #player1StaminaBar {
            background-color: var(--stamina-color);
        }

        #player2StaminaBar {
            background-color: var(--stamina-color);
            left: auto;
            right: 0;
        }

        .health-bar-container.p1,
        .stamina-bar-container.p1 {
            transform: scaleX(-1);
        }

        .health-bar-container.p1 #player1HealthBar,
        .stamina-bar-container.p1 #player1StaminaBar {
            transform: scaleX(-1);
        }

        .player-info {
            display: flex;
            flex-direction: column;
            width: 45%;
            align-items: flex-start;
        }

        .player-info.p2 {
            align-items: flex-end;
        }

        .player-name {
            font-size: clamp(0.7rem, 1.5vw, 1.1rem);
            margin-bottom: 5px;
            text-shadow: 1px 1px #000;
        }

        .player-name.p2 {
            text-align: right;
        }

        #timer {
            font-size: clamp(1rem, 2vw, 1.2rem);
            color: var(--ui-color);
            text-shadow: 1px 1px #000;
            width: 80px;
            text-align: center;
        }

        #gameCanvas {
            background-image: url('https://placehold.co/800x450/111/444?text=Arena+MK');
            background-size: cover;
            border: 4px solid #4b5563;
            border-radius: 8px;
            touch-action: none;
            width: 100%;
            max-width: 800px;
            aspect-ratio: 16 / 9;
        }

        .message-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2d3748;
            padding: 30px;
            border-radius: 12px;
            border: 5px solid black;
            z-index: 10;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
            max-width: 600px;
            width: 90%;
            max-height: 95vh;
            overflow-y: auto;
            animation: fadeIn 0.5s ease-in-out;
            color: var(--ui-color);
            font-size: 14px;
        }

        @media (min-width: 768px) {
            .message-container {
                max-width: 800px;
            }

            .message-container .controls {
                flex-direction: row;
                justify-content: space-around;
            }
        }

        .home-title {
            font-size: clamp(2rem, 5vw, 4rem);
            margin-bottom: 20px;
            color: #fff;
            text-shadow: 3px 3px 0 #8b0000,
                6px 6px 0 #ffa500;
        }

        .message-container .subtitle {
            font-size: clamp(0.9rem, 2vw, 1.5rem);
            color: #cbd5e1;
            margin-bottom: 20px;
            text-shadow: 1px 1px #000;
        }

        .message-container p {
            font-size: clamp(0.7rem, 1.5vw, 1.1rem);
            margin-bottom: 10px;
            color: #e5e7eb;
            line-height: 1.5;
            text-shadow: 1px 1px #000;
        }

        .message-container .controls {
            margin-top: 20px;
            text-align: left;
            padding: 0 10px;
            word-wrap: break-word;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message-container .controls .player-controls {
            background-color: #4b5563;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #6b7280;
            flex: 1;
        }

        .message-container .key {
            color: #fca5a5;
            text-shadow: 1px 1px #000;
        }

        .message-container .fatality-key {
            color: #ff0000;
            font-weight: bold;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
            width: 100%;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .input-group input {
            background-color: #374151;
            border: 2px solid #6b7280;
            border-radius: 5px;
            color: var(--ui-color);
            font-family: 'Press Start 2P', cursive;
            padding: 8px;
            font-size: clamp(0.7rem, 1.5vw, 1rem);
            width: 100%;
            box-sizing: border-box;
            text-align: center;
        }

        .message-container button {
            background: linear-gradient(180deg, var(--button-start-color), var(--button-end-color));
            color: var(--button-text-color);
            border: 3px solid #000;
            padding: 12px 25px;
            font-family: 'Press Start 2P', cursive;
            border-radius: 8px;
            cursor: pointer;
            font-size: clamp(0.9rem, 2vw, 1.2rem);
            box-shadow: 0 6px 0 #8b0000, 0 8px 10px rgba(0, 0, 0, 0.5);
            transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out;
            flex: 1;
        }

        #controlsButton,
        #backToHomeFromControls {
            background: #4b5563;
            box-shadow: 0 6px 0 #2d3748, 0 8px 10px rgba(0, 0, 0, 0.5);
            color: var(--ui-color);
            border-color: #000;
        }

        #controlsButton:active,
        #backToHomeFromControls:active {
            box-shadow: 0 2px 0 #2d3748;
        }

        @media (min-width: 768px) {
            .button-group {
                flex-direction: row;
            }
        }

        .message-container button:hover {
            box-shadow: 0 4px 0 #8b0000, 0 6px 8px rgba(0, 0, 0, 0.5);
        }

        .message-container button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #8b0000;
        }

        #finishHim {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: clamp(2rem, 5vw, 4rem);
            color: #ff0000;
            text-shadow: 3px 3px #000;
            animation: pulse 1s infinite;
            display: none;
            z-index: 10;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        /* Character Selection Styles */
        .character-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .character-option {
            background-color: #374151;
            border: 3px solid #6b7280;
            border-radius: 8px;
            cursor: pointer;
            padding: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            text-align: center;
        }

        .character-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }

        .character-option.selected-p1 {
            border-color: var(--player1-color);
            box-shadow: 0 0 15px var(--player1-color);
        }

        .character-option.selected-p2 {
            border-color: var(--player2-color);
            box-shadow: 0 0 15px var(--player2-color);
        }

        .character-option img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: auto;
            filter: drop-shadow(0 0 5px rgba(0, 0, 0, 0.5));
            image-rendering: pixelated;
        }

        .character-option .character-name {
            margin-top: 5px;
            font-size: clamp(0.6rem, 1.2vw, 0.9rem);
            color: var(--ui-color);
            text-shadow: 1px 1px #000;
        }
    </style>
</head>

<body>
    <div id="finishHim">FATALITY!</div>
    <div id="messageBox" class="message-container">
        <div id="homeScreenContent">
            <h2 class="home-title">MORTAL KOMBAT</h2>
            <p class="subtitle">Insira o nome dos jogadores:</p>
            <div class="input-group">
                <input type="text" id="player1NameInput" placeholder="JOGADOR 1" maxlength="10">
                <input type="text" id="player2NameInput" placeholder="JOGADOR 2" maxlength="10">
            </div>
            <div class="button-group">
                <button id="mainButton">Começar</button>
                <button id="controlsButton">Controles</button>
            </div>
        </div>
        <div id="characterSelectionContent" style="display: none;">
            <h2 class="home-title" style="text-shadow: 2px 2px #4b5563;">Escolha seu Lutador</h2>
            <div id="player1Selection">
                <p class="subtitle">Jogador 1</p>
                <div id="player1CharGrid" class="character-selection-grid"></div>
            </div>
            <div id="player2Selection" style="margin-top: 20px;">
                <p class="subtitle">Jogador 2</p>
                <div id="player2CharGrid" class="character-selection-grid"></div>
            </div>
            <div class="button-group">
                <button id="confirmSelectionButton">Confirmar e Lutar</button>
                <button id="backFromSelectionButton">Voltar</button>
            </div>
        </div>
        <div id="controlsScreenContent" style="display: none;">
            <h2 class="home-title" style="text-shadow: 2px 2px #4b5563;">Controles</h2>
            <div class="controls">
                <div class="player-controls">
                    <p>• Jogador 1:</p>
                    <p>Mover: <span class="key">A, D</span></p>
                    <p>Pular: <span class="key">W</span></p>
                    <p>Bloquear: <span class="key">S</span></p>
                    <p>Ataques: <span class="key">Q</span> (soco), <span class="key">E</span> (chute)</p>
                    <p>Golpe Especial: <span class="fatality-key">X</span></p>
                </div>
                <div class="player-controls">
                    <p>• Jogador 2:</p>
                    <p>Mover: <span class="key">Setas Direcionais</span></p>
                    <p>Pular: <span class="key">Seta para Cima</span></p>
                    <p>Bloquear: <span class="key">Seta para Baixo</span></p>
                    <p>Ataques: <span class="key">K</span> (soco), <span class="key">L</span> (chute)</p>
                    <p>Golpe Especial: <span class="fatality-key">I</span></p>
                </div>
            </div>
            <div class="button-group">
                <button id="backToHomeFromControls">Voltar</button>
            </div>
        </div>
        <div id="endGameContent" style="display: none;">
            <h2 class="home-title" id="endGameTitle"></h2>
            <div class="button-group">
                <button id="playAgainButton">Jogar Novamente</button>
                <button id="backToHomeButton">Voltar para Início</button>
            </div>
        </div>
    </div>

    <div class="game-container" style="display:none;">
        <div class="ui-container">
            <div class="player-info">
                <div class="player-name" id="player1Name"></div>
                <div class="health-bar-container p1">
                    <div id="player1HealthBar"></div>
                </div>
                <div class="stamina-bar-container p1">
                    <div id="player1StaminaBar"></div>
                </div>
            </div>
            <div id="timer"></div>
            <div class="player-info p2">
                <div class="player-name p2" id="player2Name"></div>
                <div class="health-bar-container">
                    <div id="player2HealthBar"></div>
                </div>
                <div class="stamina-bar-container">
                    <div id="player2StaminaBar"></div>
                </div>
            </div>
        </div>
        <canvas id="gameCanvas"></canvas>
    </div>

    <script>
        window.onload = function () {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const homeScreenContent = document.getElementById('homeScreenContent');
            const characterSelectionContent = document.getElementById('characterSelectionContent');
            const controlsScreenContent = document.getElementById('controlsScreenContent');
            const endGameContent = document.getElementById('endGameContent');
            const mainButton = document.getElementById('mainButton');
            const controlsButton = document.getElementById('controlsButton');
            const playAgainButton = document.getElementById('playAgainButton');
            const backToHomeButton = document.getElementById('backToHomeButton');
            const backToHomeFromControls = document.getElementById('backToHomeFromControls');
            const confirmSelectionButton = document.getElementById('confirmSelectionButton');
            const backFromSelectionButton = document.getElementById('backFromSelectionButton');
            const endGameTitle = document.getElementById('endGameTitle');
            const messageBox = document.getElementById('messageBox');
            const gameContainer = document.querySelector('.game-container');
            const player1HealthBar = document.getElementById('player1HealthBar');
            const player2HealthBar = document.getElementById('player2HealthBar');
            const player1StaminaBar = document.getElementById('player1StaminaBar');
            const player2StaminaBar = document.getElementById('player2StaminaBar');
            const player1NameInput = document.getElementById('player1NameInput');
            const player2NameInput = document.getElementById('player2NameInput');
            const player1NameDisplay = document.getElementById('player1Name');
            const player2NameDisplay = document.getElementById('player2Name');
            const timerDisplay = document.getElementById('timer');
            const finishHimDisplay = document.getElementById('finishHim');
            const player1CharGrid = document.getElementById('player1CharGrid');
            const player2CharGrid = document.getElementById('player2CharGrid');

            // Game settings
            const canvasWidth = 800;
            const canvasHeight = 450;
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;

            const groundY = canvasHeight - 30;
            const gravity = 0.5;
            const jumpPower = -12;
            const moveSpeed = 4;
            const fireballSpeed = 6;
            const playerSize = { width: 80, height: 130 }; // Tamanho das imagens

            let gameStarted = false;
            let gameOver = false;
            let fatalityMode = false;
            let fatalityAnimationActive = false;
            let keys = {};
            let projectiles = [];
            let timer = 99;
            let timerId;
            let animationFrameId;
            let fatalityTimeoutId;

            let player1SelectedChar = null;
            let player2SelectedChar = null;
            let player1CharacterName = 'JOGADOR 1';
            let player2CharacterName = 'JOGADOR 2';

            const characters = [
                { name: 'Eduardo', image: 'public/eduardo.png' },
                { name: 'Felipe', image: 'public/felipe.png' },
                { name: 'Marcelo', image: 'public/marcelo.png' },
                { name: 'Thiago', image: 'public/thiago.png' }
            ];

            // Platforms
            const platforms = [
                { x: 100, y: 300, width: 150, height: 20 },
                { x: 550, y: 300, width: 150, height: 20 },
                { x: 325, y: 200, width: 150, height: 20 }
            ];

            // Sounds with Tone.js
            const fatalitySynth = new Tone.Synth({
                oscillator: { type: "sawtooth" },
                envelope: {
                    attack: 0.05,
                    decay: 0.2,
                    sustain: 0.1,
                    release: 0.5,
                }
            }).toDestination();

            const fireballSynth = new Tone.NoiseSynth({
                noise: { type: "pink" },
                envelope: {
                    attack: 0.005,
                    decay: 0.1,
                    sustain: 0,
                    release: 0.1,
                }
            }).toDestination();

            const punchSynth = new Tone.MembraneSynth().toDestination();
            const kickSynth = new Tone.MembraneSynth({
                pitchDecay: 0.05,
                octaves: 10,
                envelope: {
                    attack: 0.001,
                    decay: 0.4,
                    sustain: 0.01,
                    release: 1.4,
                    attackCurve: "exponential"
                }
            }).toDestination();

            // Player class
            class Player {
                constructor({ x, y, character, keysConfig, direction, name }) {
                    this.x = x;
                    this.y = y;
                    this.width = playerSize.width;
                    this.height = playerSize.height;
                    this.character = character;
                    this.image = new Image();
                    this.image.src = this.character.image;
                    this.name = name;
                    this.health = 100;
                    this.stamina = 100;
                    this.maxStamina = 100;
                    this.velocity = { x: 0, y: 0 };
                    this.isJumping = false;
                    this.isAttacking = false;
                    this.isBlocking = false;
                    this.isDead = false;
                    this.lastAttackTime = 0;
                    this.attackCooldown = 500;
                    this.keysConfig = keysConfig;
                    this.direction = direction;
                }

                draw() {
                    if (this.isDead) return;

                    ctx.save();
                    ctx.textAlign = 'center';
                    ctx.font = "12px 'Press Start 2P', cursive";
                    ctx.fillStyle = this.playerColor; // Cor do nome
                    ctx.fillText(this.name, this.x + this.width / 2, this.y - 10);

                    if (this.direction === 'left') {
                        ctx.translate(this.x + this.width, this.y);
                        ctx.scale(-1, 1);
                        ctx.drawImage(this.image, 0, 0, this.width, this.height);
                    } else {
                        ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
                    }

                    if (this.isAttacking) {
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                        ctx.fillRect(0, 0, this.width, this.height);
                    }

                    ctx.restore();
                }

                update() {
                    if (this.isDead) {
                        this.velocity.x = 0;
                        this.velocity.y = 0;
                        return;
                    }
                    this.draw();
                    this.x += this.velocity.x;
                    this.y += this.velocity.y;

                    let onPlatform = false;
                    let newY = this.y + this.velocity.y;

                    // Check for collisions with platforms
                    platforms.forEach(platform => {
                        if (
                            this.y + this.height <= platform.y &&
                            newY + this.height >= platform.y &&
                            this.x + this.width >= platform.x &&
                            this.x <= platform.x + platform.width
                        ) {
                            // Land on platform
                            this.velocity.y = 0;
                            this.y = platform.y - this.height;
                            this.isJumping = false;
                            onPlatform = true;
                        }
                    });

                    // Check for collision with ground
                    if (!onPlatform && this.y + this.height < groundY) {
                        this.velocity.y += gravity;
                    } else if (!onPlatform) {
                        this.velocity.y = 0;
                        this.y = groundY - this.height;
                        this.isJumping = false;
                    }

                    if (this.y + this.height >= groundY) {
                        this.isJumping = false;
                    }

                    if (this.x < 0) this.x = 0;
                    if (this.x + this.width > canvas.width) this.x = canvas.width - this.width;
                }

                jump() {
                    let onGround = this.y + this.height >= groundY;
                    let onPlatform = platforms.some(platform =>
                        this.y + this.height === platform.y &&
                        this.x + this.width > platform.x &&
                        this.x < platform.x + platform.width
                    );

                    if (!this.isJumping && (onGround || onPlatform)) {
                        this.velocity.y = jumpPower;
                        this.isJumping = true;
                    }
                }

                takeHit(damage) {
                    if (this.isBlocking) {
                        this.stamina -= damage;
                        if (this.stamina < 0) {
                            this.stamina = 0;
                            this.isBlocking = false;
                        }
                    } else {
                        this.health -= damage;
                    }
                    if (this.health < 0) this.health = 0;
                }

                punch() {
                    if (Date.now() - this.lastAttackTime > this.attackCooldown) {
                        punchSynth.triggerAttackRelease("C4", "8n");
                        this.isAttacking = true;
                        this.lastAttackTime = Date.now();
                        setTimeout(() => {
                            this.isAttacking = false;
                        }, 200);
                        return { damage: 10, range: 40, yOffset: this.height / 2, height: 20, width: 40 };
                    }
                    return null;
                }

                kick() {
                    if (Date.now() - this.lastAttackTime > this.attackCooldown) {
                        kickSynth.triggerAttackRelease("G3", "8n");
                        this.isAttacking = true;
                        this.lastAttackTime = Date.now();
                        setTimeout(() => {
                            this.isAttacking = false;
                        }, 200);
                        return { damage: 15, range: 60, yOffset: this.height - 30, height: 20, width: 60 };
                    }
                    return null;
                }

                fireball() {
                    const fireballCost = 30;
                    if (this.stamina >= fireballCost && Date.now() - this.lastAttackTime > 1500) {
                        fireballSynth.triggerAttackRelease("8n");
                        this.stamina -= fireballCost;
                        this.lastAttackTime = Date.now();
                        const projectileSpeed = this.direction === 'left' ? -fireballSpeed : fireballSpeed;
                        const projectileX = this.x + (this.direction === 'left' ? -20 : this.width);
                        projectiles.push(new Projectile({
                            x: projectileX,
                            y: this.y + this.height / 2 - 5,
                            width: 20,
                            height: 10,
                            color: getComputedStyle(document.documentElement).getPropertyValue('--fireball-color'),
                            velocity: projectileSpeed,
                            owner: this
                        }));
                    }
                }
            }

            // Projectile class (Fireball)
            class Projectile {
                constructor({ x, y, width, height, color, velocity, owner }) {
                    this.x = x;
                    this.y = y;
                    this.width = width;
                    this.height = height;
                    this.color = color;
                    this.velocity = velocity;
                    this.owner = owner;
                    this.isHit = false;
                }

                draw() {
                    ctx.fillStyle = this.color;
                    ctx.fillRect(this.x, this.y, this.width, this.height);
                }

                update() {
                    this.x += this.velocity;
                    this.draw();
                }
            }

            let player1, player2;

            function initGame() {
                if (!player1SelectedChar || !player2SelectedChar) {
                    // Use a custom message box instead of alert()
                    const messageBox = document.createElement('div');
                    messageBox.className = 'message-container';
                    messageBox.innerHTML = `
                        <h2 class="home-title">Erro!</h2>
                        <p class="subtitle">Por favor, selecione um personagem para cada jogador.</p>
                        <button id="closeError">OK</button>
                    `;
                    document.body.appendChild(messageBox);
                    document.getElementById('closeError').addEventListener('click', () => {
                        document.body.removeChild(messageBox);
                    });
                    return;
                }

                if (animationFrameId) { cancelAnimationFrame(animationFrameId); }
                if (timerId) { clearInterval(timerId); }

                player1NameDisplay.innerText = player1NameInput.value.trim() || player1CharacterName;
                player2NameDisplay.innerText = player2NameInput.value.trim() || player2CharacterName;

                messageBox.style.display = 'none';
                gameContainer.style.display = 'flex';
                finishHimDisplay.style.display = 'none';

                player1 = new Player({
                    x: 100, y: groundY - playerSize.height,
                    character: player1SelectedChar,
                    keysConfig: { left: 'a', right: 'd', jump: 'w', block: 's', punch: 'q', kick: 'e', fireball: 'x' },
                    direction: 'right',
                    name: player1NameDisplay.innerText
                });
                player2 = new Player({
                    x: canvasWidth - 100 - playerSize.width, y: groundY - playerSize.height,
                    character: player2SelectedChar,
                    keysConfig: { left: 'ArrowLeft', right: 'ArrowRight', jump: 'ArrowUp', block: 'ArrowDown', punch: 'k', kick: 'l', fireball: 'i' },
                    direction: 'left',
                    name: player2NameDisplay.innerText
                });

                gameStarted = true;
                gameOver = false;
                fatalityMode = false;
                fatalityAnimationActive = false;
                keys = {};
                projectiles = [];
                timer = 99;

                timerId = setInterval(() => {
                    timer--;
                    if (timer <= 0) { endGame(); }
                }, 1000);

                animate();
            }

            function endGame(winner = null) {
                gameOver = true;
                clearInterval(timerId);
                cancelAnimationFrame(animationFrameId);
                messageBox.style.display = 'block';
                gameContainer.style.display = 'none';
                finishHimDisplay.style.display = 'none';

                homeScreenContent.style.display = 'none';
                controlsScreenContent.style.display = 'none';
                characterSelectionContent.style.display = 'none';
                endGameContent.style.display = 'block';

                endGameTitle.innerText = winner ? `${winner} Venceu!` : 'Empate!';
            }

            function showHomeScreen() {
                if (animationFrameId) { cancelAnimationFrame(animationFrameId); }
                if (timerId) { clearInterval(timerId); }
                if (fatalityTimeoutId) { clearTimeout(fatalityTimeoutId); }

                gameStarted = false;
                gameOver = false;
                fatalityMode = false;
                fatalityAnimationActive = false;
                keys = {};
                projectiles = [];
                timer = 99;

                // Clear selection states
                player1SelectedChar = null;
                player2SelectedChar = null;
                document.querySelectorAll('.character-option').forEach(el => {
                    el.classList.remove('selected-p1', 'selected-p2');
                });

                messageBox.style.display = 'block';
                gameContainer.style.display = 'none';
                finishHimDisplay.style.display = 'none';

                controlsScreenContent.style.display = 'none';
                endGameContent.style.display = 'none';
                characterSelectionContent.style.display = 'none';
                homeScreenContent.style.display = 'block';
            }

            function showControlsScreen() {
                homeScreenContent.style.display = 'none';
                controlsScreenContent.style.display = 'block';
            }

            function showCharacterSelectionScreen() {
                homeScreenContent.style.display = 'none';
                characterSelectionContent.style.display = 'block';
            }

            function updateHealthBars() {
                player1HealthBar.style.width = `${player1.health}%`;
                player2HealthBar.style.width = `${player2.health}%`;
                player1StaminaBar.style.width = `${player1.stamina}%`;
                player2StaminaBar.style.width = `${player2.stamina}%`;

                if (player1.health <= 30) player1HealthBar.style.backgroundColor = 'red';
                else if (player1.health <= 60) player1HealthBar.style.backgroundColor = 'orange';
                else player1HealthBar.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--player1-color');

                if (player2.health <= 30) player2HealthBar.style.backgroundColor = 'red';
                else if (player2.health <= 60) player2HealthBar.style.backgroundColor = 'orange';
                else player2HealthBar.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--player2-color');
            }

            function animate() {
                if (gameOver) return;

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Draw ground
                ctx.fillStyle = '#333';
                ctx.fillRect(0, groundY, canvasWidth, canvasHeight - groundY);

                // Draw platforms
                ctx.fillStyle = '#6b7280';
                platforms.forEach(platform => {
                    ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                });

                if (fatalityAnimationActive) {
                    // Fatality animation logic would go here
                    // This is a placeholder as PNGs dont support the old animation
                } else if (fatalityMode) {
                    player1.velocity.x = 0;
                    player2.velocity.x = 0;
                    player1.update();
                    player2.update();
                } else {
                    player1.velocity.x = 0;
                    player2.velocity.x = 0;
                    player1.isBlocking = keys[player1.keysConfig.block];
                    player2.isBlocking = keys[player2.keysConfig.block];

                    if (keys[player1.keysConfig.left]) { player1.velocity.x = -moveSpeed; player1.direction = 'left'; }
                    if (keys[player1.keysConfig.right]) { player1.velocity.x = moveSpeed; player1.direction = 'right'; }
                    if (keys[player1.keysConfig.jump]) { player1.jump(); }

                    if (keys[player2.keysConfig.left]) { player2.velocity.x = -moveSpeed; player2.direction = 'left'; }
                    if (keys[player2.keysConfig.right]) { player2.velocity.x = moveSpeed; player2.direction = 'right'; }
                    if (keys[player2.keysConfig.jump]) { player2.jump(); }

                    // Flip player direction based on opponent's position
                    if (player1.x < player2.x) {
                        player1.direction = 'right';
                        player2.direction = 'left';
                    } else {
                        player1.direction = 'left';
                        player2.direction = 'right';
                    }

                    player1.update();
                    player2.update();

                    // Check attack collision
                    const checkCollision = (attacker, defender, attack) => {
                        const attackX = attacker.direction === 'right' ? attacker.x + attacker.width : attacker.x - attack.width;
                        const attackY = attacker.y + attack.yOffset;
                        if (
                            attackX + attack.width >= defender.x &&
                            attackX <= defender.x + defender.width &&
                            attackY + attack.height >= defender.y &&
                            attackY <= defender.y + defender.height
                        ) {
                            defender.takeHit(attack.damage);
                        }
                    };

                    if (keys[player1.keysConfig.punch]) {
                        const attack = player1.punch();
                        if (attack) checkCollision(player1, player2, attack);
                    }
                    if (keys[player1.keysConfig.kick]) {
                        const attack = player1.kick();
                        if (attack) checkCollision(player1, player2, attack);
                    }
                    if (keys[player1.keysConfig.fireball]) { player1.fireball(); }

                    if (keys[player2.keysConfig.punch]) {
                        const attack = player2.punch();
                        if (attack) checkCollision(player2, player1, attack);
                    }
                    if (keys[player2.keysConfig.kick]) {
                        const attack = player2.kick();
                        if (attack) checkCollision(player2, player1, attack);
                    }
                    if (keys[player2.keysConfig.fireball]) { player2.fireball(); }

                    // Check projectile collision
                    projectiles.forEach((p, index) => {
                        p.update();
                        const opponent = p.owner === player1 ? player2 : player1;
                        if (
                            p.x + p.width >= opponent.x &&
                            p.x <= opponent.x + opponent.width &&
                            p.y + p.height >= opponent.y &&
                            p.y <= opponent.y + opponent.height
                        ) {
                            if (!p.isHit) {
                                opponent.takeHit(25);
                                p.isHit = true;
                                projectiles.splice(index, 1);
                            }
                        }
                        if (p.x < -p.width || p.x > canvas.width) {
                            projectiles.splice(index, 1);
                        }
                    });
                }

                updateHealthBars();
                timerDisplay.innerText = timer;

                // Check fatality condition
                if (player1.health <= 10 && !fatalityMode && !fatalityAnimationActive) {
                    fatalityMode = true;
                    finishHimDisplay.style.display = 'block';
                    fatalitySynth.triggerAttackRelease("C4", "1s");
                }
                if (player2.health <= 10 && !fatalityMode && !fatalityAnimationActive) {
                    fatalityMode = true;
                    finishHimDisplay.style.display = 'block';
                    fatalitySynth.triggerAttackRelease("C4", "1s");
                }

                if (player1.health <= 0) { endGame(player2.name); }
                if (player2.health <= 0) { endGame(player1.name); }

                animationFrameId = requestAnimationFrame(animate);
            }

            document.addEventListener('keydown', (e) => {
                if (!gameStarted) return;
                keys[e.key] = true;
                keys[e.key.toLowerCase()] = true;

                if (fatalityMode && !fatalityAnimationActive) {
                    if (e.key.toLowerCase() === 'x' && player1.health > 0) {
                        fatalityAnimationActive = true;
                        endGame(player1.name); // Finaliza o jogo na Fatality
                    }
                    if (e.key.toLowerCase() === 'i' && player2.health > 0) {
                        fatalityAnimationActive = true;
                        endGame(player2.name); // Finaliza o jogo na Fatality
                    }
                }
            });

            document.addEventListener('keyup', (e) => {
                if (!gameStarted) return;
                keys[e.key] = false;
                keys[e.key.toLowerCase()] = false;
            });

            // UI Button Handlers
            mainButton.addEventListener('click', showCharacterSelectionScreen);
            controlsButton.addEventListener('click', showControlsScreen);
            backToHomeFromControls.addEventListener('click', showHomeScreen);
            confirmSelectionButton.addEventListener('click', initGame);
            backFromSelectionButton.addEventListener('click', showHomeScreen);
            playAgainButton.addEventListener('click', initGame);
            backToHomeButton.addEventListener('click', showHomeScreen);

            // Populate character selection grids
            function populateCharSelection(grid, playerNumber) {
                grid.innerHTML = '';
                characters.forEach(char => {
                    const charDiv = document.createElement('div');
                    charDiv.classList.add('character-option');
                    charDiv.setAttribute('data-char-name', char.name);
                    const img = document.createElement('img');
                    img.src = char.image;
                    img.alt = char.name;
                    const charName = document.createElement('div');
                    charName.classList.add('character-name');
                    charName.innerText = char.name;
                    charDiv.append(img, charName);

                    charDiv.addEventListener('click', () => {
                        document.querySelectorAll(`.character-option.selected-p${playerNumber}`).forEach(el => {
                            el.classList.remove(`selected-p${playerNumber}`);
                        });
                        charDiv.classList.add(`selected-p${playerNumber}`);
                        if (playerNumber === 1) {
                            player1SelectedChar = char;
                            player1CharacterName = char.name;
                        } else {
                            player2SelectedChar = char;
                            player2CharacterName = char.name;
                        }
                    });
                    grid.appendChild(charDiv);
                });
            }

            populateCharSelection(player1CharGrid, 1);
            populateCharSelection(player2CharGrid, 2);

            // Show the home screen initially
            showHomeScreen();
        }
    </script>
</body>

</html>